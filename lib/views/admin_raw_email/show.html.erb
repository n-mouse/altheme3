<%= render :partial => 'admin_incoming_message/intro', :locals => { :incoming_message => @raw_email.incoming_message } %>

<% if @holding_pen %>
  <br>
  This is in the holding pen because: <strong><%= @rejected_reason %></strong>



  <% if @guessed_info_requests.any? %>
  <div class="row">
    <div class="accordion span12" id="guessed-requests">
      Guessed request:
      <% @guessed_info_requests.each do |guess|  %>
        <div class="accordion-group">
          <div class="accordion-heading">
            <a href="#info_request_<%= guess.info_request.id %>" data-toggle="collapse"><i class="icon-chevron-right"></i></a>
            <%= request_both_links(guess.info_request) %>
          </div>

          <div class="accordion-body collapse" id="info_request_<%= guess.info_request.id %>">
            <table class="table table-striped table-condensed">
              <tr>
                <td><strong>Last outgoing message:</strong></td>
                <td><%= guess.info_request.outgoing_messages.last.body %></td>
              </tr>

              <tr>
                <td><strong>Created by:</strong></td>
                <td><%= user_admin_link_for_request(guess.info_request) %></td>
              </tr>

              <tr>
                <td><strong>Authority:</strong></td>
                <td>
                  <%= link_to(guess.info_request.public_body.name, admin_body_path(guess.info_request.public_body)) %>
                </td>
              </tr>

              <tr>
                <td><strong>url_title:</strong></td>
                <td><%= guess.info_request.url_title %></td>
              </tr>
            </table>

            <p>
              This request was guessed based on
              <code><%= guess.match_method %></code>
              <% if guess.match_method == :subject %>
                because the incoming message has a subject of
                <strong><%= guess.matched_value %></strong>
              <% else %>
                because it has an incoming email address
                of <strong><%= guess.info_request.incoming_email %></strong>
                and this incoming message was sent to
              <strong><%= guess.matched_value %></strong>.
              <% end %>

            </p>
          </div>
        </div>
      <% end %>
    </div>
    </div>
  <% end %>
<% end %>

<div>
  <%= render :partial => 'admin_incoming_message/actions', :locals => { :incoming_message => @raw_email.incoming_message } %>
</div>

<h2>Raw email</h2>

<p><%= link_to "Download",  admin_raw_email_path(@raw_email, :format => 'eml'), :class => 'btn' %></p>

<h2>Preview</h2>

<p>For an exact rendering of this email, use the "Download" link.</p>

<table class="table table-striped table-condensed table-hover">
  <thead>
    <tr>
      <th colspan=2>
        Parsed Headers:
      </th>
    </tr>
  </thead>
  <tr>
    <td><strong>From:</strong></td>
    <td><%= address_list(@raw_email.mail.from) %></td>
  </tr>
  <tr>
    <td><strong>SMTP Envelope-From:</strong></td>
    <td><%= address_list(@raw_email.mail.smtp_envelope_from) %></td>
  </tr>
  <tr>
    <td><strong>Envelope-From:</strong></td>
    <td><%= address_list(@raw_email.mail.envelope_from) %></td>
  </tr>
  <tr>
    <td><strong>To:</strong></td>
    <td><%= address_list(@raw_email.mail.to) %></td>
  </tr>
  <tr>
    <td><strong>Envelope-To:</strong></td>
    <td><%= address_list(@raw_email.mail.smtp_envelope_to) %></td>
  </tr>
  <tr>
    <td><strong>Cc:</strong></td>
    <td><%= address_list(@raw_email.mail.cc) %></td>
  </tr>
  <tr>
    <td><strong>Bcc:</strong></td>
    <td><%= address_list(@raw_email.mail.bcc) %></td>
  </tr>
  <tr>
    <td><strong>Subject:</strong></td>
    <td><%= @raw_email.mail.subject %></td>
  </tr>
</table>

<pre><%= h(@raw_email.data_as_text).gsub(/\n/, '<br>').html_safe %></pre>
